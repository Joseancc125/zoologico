<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Zoológico — Dashboard</title>
    <style>
      body { font-family: Arial, sans-serif; margin: 20px; }
      .alert { border: 1px solid #ddd; padding: 8px; margin-bottom: 8px; border-radius: 4px; }
      .meta { color: #666; font-size: 12px; }
    </style>
  </head>
  <body>
    <h1>Zoológico — Dashboard (PoC)</h1>
    <p>Últimas alertas recibidas por el orquestador.</p>
    <div>
      <label>Mostrar <input id="limit" type="number" value="20" style="width:70px" /></label>
      <button id="refresh">Refrescar</button>
    </div>
    <div id="alerts"></div>

    <script>
      async function load() {
        const limit = document.getElementById('limit').value || 20;
        const res = await fetch('/alerts?limit=' + limit);
        const j = await res.json();
        const container = document.getElementById('alerts');
        container.innerHTML = '';
        <!doctype html>
        <html lang="es">
          <head>
            <meta charset="utf-8" />
            <meta name="viewport" content="width=device-width, initial-scale=1" />
            <title>Zoológico — Dashboard</title>
            <style>
              :root{--bg:#f7f9fb;--card:#fff;--muted:#6b7280;--accent:#0ea5a4}
              body{font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; background:var(--bg); margin:18px}
              .wrap{max-width:1100px;margin:0 auto}
              header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
              h1{font-size:20px;margin:0}
              .controls{display:flex;gap:8px;align-items:center}
              input[type=search], input[type=number], select{padding:6px 8px;border:1px solid #e5e7eb;border-radius:6px}
              button{background:var(--accent);color:#fff;border:none;padding:8px 10px;border-radius:6px;cursor:pointer}
              .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
              .card{background:var(--card);border:1px solid #e6eef0;padding:12px;border-radius:8px;box-shadow:0 1px 2px rgba(16,24,40,0.03)}
              .thumb{width:100%;height:180px;object-fit:cover;border-radius:6px;background:#eef}
              .meta{color:var(--muted);font-size:13px;margin-top:6px}
              pre{background:#0b1220;color:#e6eef8;padding:8px;border-radius:6px;overflow:auto;font-size:12px}
              .row{display:flex;gap:8px;align-items:center}
              .tag{background:#eef7f7;color:#056; padding:4px 8px;border-radius:999px;font-size:12px}
              .empty{padding:18px;color:var(--muted)}
            </style>
          </head>
          <body>
            <div class="wrap">
              <header>
                <h1>Zoológico — Alertas</h1>
                <div class="controls">
                  <a href="/visual" class="btn">Ver topología</a>
                  <input id="q" type="search" placeholder="Filtrar por camera_id o texto..." />
                  <select id="has_thumb">
                    <option value="any">Cualquiera</option>
                    <option value="yes">Con miniatura</option>
                    <option value="no">Sin miniatura</option>
                  </select>
                  <label>Mostrar <input id="limit" type="number" value="20" style="width:70px" /></label>
                  <button id="refresh">Refrescar</button>
                </div>
              </header>

              <div id="alerts_container" class="grid"></div>
              <div id="empty" class="empty" style="display:none">No se encontraron alertas.</div>
            </div>

            <script>
              function hasThumb(a){ return Boolean(a.thumbnail_url || a.frame_url || a.frame_path || (a.detections && a.detections.length && a.detections[0].thumbnail)); }

              function formatTime(v){
                if(!v) return '';
                const n = Number(v);
                if(!isNaN(n)){
                  if(n>1e12) return new Date(n).toLocaleString();
                  const now = Date.now()/1000;
                  const diff = Math.round(now - n);
                  if(diff>=0) return diff + 's ago';
                  return 'at ' + n;
                }
                try{ return new Date(v).toLocaleString() }catch(e){return String(v)}
              }

              function renderItem(a){
                const c = document.createElement('div'); c.className='card';
                const hdr = document.createElement('div'); hdr.className='row';
                const title = document.createElement('div'); title.innerHTML = '<strong>' + (a.camera_id || '—') + '</strong>';
                const tag = document.createElement('div'); tag.className='tag'; tag.textContent = (a.level||'alert');
                const ts = document.createElement('div'); ts.className='meta'; ts.style.marginLeft='auto'; ts.textContent = formatTime(a.received_at);
                hdr.appendChild(title); hdr.appendChild(tag); hdr.appendChild(ts);
                c.appendChild(hdr);

                if(hasThumb(a)){
                  const img = document.createElement('img'); img.className='thumb';
                  img.src = a.thumbnail_url || a.frame_url || a.frame_path || (a.detections && a.detections[0].thumbnail) || '';
                  img.alt = 'thumbnail';
                  img.onerror = ()=>{ img.style.display='none' };
                  c.appendChild(img);
                }

                if(a.detections && a.detections.length){
                  const list = document.createElement('div'); list.className='meta';
                  list.textContent = 'Detections: ' + a.detections.map(d=>d.label||d.cls||d.name||d).slice(0,5).join(', ');
                  c.appendChild(list);
                }

                const details = document.createElement('details');
                const summary = document.createElement('summary'); summary.textContent = 'Mostrar JSON';
                const pre = document.createElement('pre'); pre.textContent = JSON.stringify(a, null, 2);
                details.appendChild(summary); details.appendChild(pre);
                c.appendChild(details);

                return c;
              }

              async function load(){
                const limit = document.getElementById('limit').value || 20;
                const q = (document.getElementById('q').value || '').toLowerCase();
                const thumbFilter = document.getElementById('has_thumb').value;
                const res = await fetch('/alerts?limit=' + limit);
                const j = await res.json();
                const container = document.getElementById('alerts_container');
                const empty = document.getElementById('empty');
                container.innerHTML = '';
                if(!j.alerts || j.alerts.length===0){ empty.style.display='block'; return }
                let list = j.alerts.slice().reverse();
                if(q) list = list.filter(a => JSON.stringify(a).toLowerCase().includes(q) || (a.camera_id && a.camera_id.toLowerCase().includes(q)) );
                if(thumbFilter==='yes') list = list.filter(hasThumb);
                if(thumbFilter==='no') list = list.filter(a => !hasThumb(a));
                if(list.length===0){ empty.style.display='block'; return } else empty.style.display='none';
                list.forEach(a=> container.appendChild(renderItem(a)));
              }

              document.getElementById('refresh').addEventListener('click', load);
              document.getElementById('q').addEventListener('keyup', ()=>{ setTimeout(load,200) });
              load();
            </script>
          </body>
        </html>
